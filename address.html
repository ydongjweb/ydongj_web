<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="css/jquery-ui.min.css">
	<link rel="stylesheet" href="css/style.css">
	<title>门店地理位置</title>
</head>
<body class="map-container">
	<div class="container">
		<header>门店使用图</header>
		<div class="form-inline" role="form">
			<button data-v='1' class="btn btn-day btn-default btn-info">今天</button>
			<button data-v='2' class="btn btn-day btn-default">昨天</button>
			<button data-v='3' class="btn btn-day btn-default">近一周</button>
			<button data-v='4' class="btn btn-day btn-default">近一月</button>
		    <input type="text" class="form-control date-input" id="dateStart" readonly="readonly">
			至
		    <input type="text" class="form-control date-input" id="dateEnd" readonly="readonly">
			<button class="btn btn-default" id="queryBtn">查询</button>
		</div>
		<div class="flex-block">
			<div class="flex-l">
				<div id="imap"></div>
			</div>
			<div class="flex-r">
				<div class="pannel-info">
					<p>今日实时销售总额（元）</p>
					<div class="sumAmount-block"></div>
				</div>	
				<div class="pannel-info">
					<p>今日实时交易笔数（笔）</p>
					<div class="orderCount-block"></div>
				</div>			
			</div>
		</div>
		
	</div>
	
	<script src="js/jquery-3.1.0.min.js"></script>
	<script type="text/javascript" src="js/jquery-ui.min.js"></script>
	<script src="http://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
	<script src="js/common.js"></script>
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=Pe2bpfL1ct54kQLPZjGvzzRqIgKA7Kda"></script>
	<script type="text/javascript">

	var startDate = endDate = new Date().Format('yyyy-MM-dd'),
		timeCommon = ' 00:00:00',
		type = 1;

	$('.btn-day, #queryBtn').on('click', function() {
		var now = new Date(),
			v = $(this).data('v');
		type = v;

		switch(v) {
			case 1 : 
				startDate = now.Format('yyyy-MM-dd');
				endDate = addDate(now, 1);
				break;
			case 2 : 
				startDate = endDate = addDate(now, -1);
				break;
			case 3 : 
				startDate = addDate(now, -7);
				endDate = now.Format('yyyy-MM-dd');
				break;
			case 4 : 
				startDate = addDate(now, -30);
				endDate = now.Format('yyyy-MM-dd');
				break;
			default: 
				startDate = $('#dateStart').val();
				endDate = $('#dateEnd').val();
		}

		$('#dateStart').val(startDate);
		$('#dateEnd').val(endDate);
		$(this).addClass('btn-info').siblings().removeClass('btn-info');
	})

	// 百度地图API功能	
	map = new BMap.Map("imap");
	map.centerAndZoom(new BMap.Point(114.057195,22.596458), 10);
	map.enableScrollWheelZoom(true);
	var top_left_navigation = new BMap.NavigationControl();  //左上角，添加默认缩放平移控件
	var size = new BMap.Size(10, 20);
	map.addControl(new BMap.CityListControl({
	    anchor: BMAP_ANCHOR_TOP_RIGHT,
	    offset: size,
	}));
	map.addControl(top_left_navigation);

	function getPoint() {
		getByAjax({
			url: 'api/address/store',
			type: 'GET',
			success: function(data) {
				if (data.code == 1) {
					for(var i = 0, len = data.datas.length; i < len; i++){
						var item = data.datas[i];
						var marker = new BMap.Marker(new BMap.Point(item.longitude,item.latitude));  // 创建标注
						map.addOverlay(marker);               // 将标注添加到地图中
						addClickHandler(item, marker);
					}
				}
			}
		})
	}

	var opts = {
		width : 250,     // 信息窗口宽度
		height: 80,     // 信息窗口高度
		title : "" , // 信息窗口标题
		enableMessage:false//设置允许信息窗发送短息
	};
	
	function addClickHandler(objItem, marker){
		marker.addEventListener("click",function(e){
			var ajaxData = '';
			if (type == 1 || type == 2) {
				ajaxData = {
					"beginTime": startDate,
		    		"endTime": endDate,
		    		"storeId": objItem.storeId
				};
			} else {
				ajaxData = {
					"beginTime": startDate + timeCommon,
		    		"endTime": endDate + timeCommon,
		    		"storeId": objItem.storeId
				};
			}

			getByAjax({
				url: 'api/trade/store',
				data: JSON.stringify(ajaxData),
				success: function(data) {
					if (data.code == 1) {
						var content = '地址: ' + objItem.address + '<br> 订单数: ' + data.datas.orderCount + ' <br> 交易金额: ' + data.datas.sumAmount,
							span = '<span style="color:#F26E01">' + content + '</span>';
						openInfo(span,e);
					}
				}
			})
		});
	}
	function openInfo(content,e){
		var p = e.target;
		var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
		var infoWindow = new BMap.InfoWindow(content,opts);  // 创建信息窗口对象 
		map.openInfoWindow(infoWindow,point); //开启信息窗口
	}

	function getTodayTrade() {
		var ajaxData = {
			"beginTime": new Date().Format('yyyy-MM-dd'),
    		"endTime": new Date().Format('yyyy-MM-dd'),
		};
		getByAjax({
			url: 'api/trade/summary',
			data: JSON.stringify(ajaxData),
			success: function(data) {
				if (data.code == 1) {
					rendTradeData(data.datas);
				}
			}
		})

		function rendTradeData(data) {
			var sumAmount = 0,
				orderCount = 0,
				sumAmountHtml = '',
				orderCountHtml = '';

			if (data) {
				sumAmount = '' + Math.round(data.sumAmount);
				sumAmountHtml = '<span class="span-li">'
				if (sumAmount.length > 0) {
					for (var i = 0, len = sumAmount.length; i < len; i++) {
						if (i%3 == 0 && i != 0) {
							sumAmountHtml += '</span><span class="span-li">'
						}
						sumAmountHtml += '<span>' + sumAmount[i] + '</span>';
					}
				}
				sumAmountHtml += '</span>';

				orderCount = '' + Math.round(data.orderCount);
				orderCountHtml = '<span class="span-li">'
				if (orderCount.length > 0) {
					for (var i = 0, len = orderCount.length; i < len; i++) {
						if (i%3 == 0 && i != 0) {
							orderCountHtml += '</span><span class="span-li">'
						}
						orderCountHtml += '<span>' + orderCount[i] + '</span>';
					}
				}
				orderCountHtml += '</span>';

				$('.sumAmount-block').html(sumAmountHtml);
				$('.orderCount-block').html(orderCountHtml);
			}
		}
	}

	window.onload = function() {
		initCommon()
		getTodayTrade();
		getPoint();
	}
</script>
</body>
</html>

